# Create a temporary copy of the .gperf file with LF line endings (required by gperf on Windows)
# Use the helper script to ensure binary write with LF and strip BOM.
execute_process(COMMAND ${PYTHON3} ${CMAKE_SOURCE_DIR}/utils/cmake_helper.py convert-eol
	"${CMAKE_SOURCE_DIR}/contrib/libsvgtiny/src/colors.gperf"
	"${CMAKE_BINARY_DIR}/contrib/libsvgtiny/colors.gperf"
	RESULT_VARIABLE RET)
if(NOT RET EQUAL 0)
	message(FATAL_ERROR "EOL conversion for libsvgtiny failed (error ${RET})")
endif()

execute_process(COMMAND ${GPERF} ${CMAKE_BINARY_DIR}/contrib/libsvgtiny/colors.gperf --output-file=${CMAKE_BINARY_DIR}/contrib/libsvgtiny/autogenerated_colors.c 
	RESULT_VARIABLE RET
	OUTPUT_VARIABLE GPERF_OUT
	ERROR_VARIABLE GPERF_ERR)
if(NOT RET EQUAL 0)
	message(FATAL_ERROR "gperf for libsvgtiny failed (error ${RET})\nStdout: ${GPERF_OUT}\nStderr: ${GPERF_ERR}")
endif()

# Squash "error: no previous declaration for 'svgtiny_color_lookup'"
# Replace sed with Python helper for cross-platform compatibility
execute_process(COMMAND ${PYTHON3} ${CMAKE_SOURCE_DIR}/utils/cmake_helper.py replace
	"${CMAKE_BINARY_DIR}/contrib/libsvgtiny/autogenerated_colors.c"
	"const struct svgtiny_named_color"
	"static const struct svgtiny_named_color"
	RESULT_VARIABLE RET)
if(NOT RET EQUAL 0)
	message(FATAL_ERROR "python replacement for libsvgtiny failed (error ${RET})")
endif()

add_library(svgtiny SHARED
	src/svgtiny.c
	src/svgtiny_gradient.c
	src/svgtiny_list.c
	src/svgtiny_parse.c
	src/svgtiny_path.c
)
set_target_properties(svgtiny PROPERTIES SOVERSION ${NEOSURF_ABI})

target_link_libraries(svgtiny nsutils dom m)

install(TARGETS svgtiny DESTINATION ${CMAKE_INSTALL_LIBDIR})

install(FILES include/svgtiny.h DESTINATION ${CMAKE_INSTALL_INCLUDEDIR})
