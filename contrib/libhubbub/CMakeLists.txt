file(MAKE_DIRECTORY ${CMAKE_BINARY_DIR}/contrib/libhubbub/src/treebuilder)

# Create a temporary copy of the .gperf file with LF line endings (required by gperf on Windows)
# Use the helper script to ensure binary write with LF and strip BOM.
execute_process(COMMAND ${PYTHON3} ${CMAKE_SOURCE_DIR}/utils/cmake_helper.py convert-eol
	"${CMAKE_SOURCE_DIR}/contrib/libhubbub/src/treebuilder/element-type.gperf"
	"${CMAKE_BINARY_DIR}/contrib/libhubbub/src/treebuilder/element-type.gperf"
	RESULT_VARIABLE RET)
if(NOT RET EQUAL 0)
	message(FATAL_ERROR "EOL conversion for libhubbub failed (error ${RET})")
endif()

execute_process(COMMAND ${GPERF} ${CMAKE_BINARY_DIR}/contrib/libhubbub/src/treebuilder/element-type.gperf --output-file=${CMAKE_BINARY_DIR}/contrib/libhubbub/src/treebuilder/autogenerated-element-type.c 
	RESULT_VARIABLE RET
	OUTPUT_VARIABLE GPERF_OUT
	ERROR_VARIABLE GPERF_ERR)
if(NOT RET EQUAL 0)
	message(FATAL_ERROR "gperf for libhubbub failed (error ${RET})\nStdout: ${GPERF_OUT}\nStderr: ${GPERF_ERR}")
endif()

add_library(hubbub SHARED
	src/parser.c
	src/charset/detect.c
	src/tokeniser/entities.c
	src/tokeniser/tokeniser.c
	src/treebuilder/treebuilder.c
	src/treebuilder/initial.c
	src/treebuilder/before_html.c
	src/treebuilder/before_head.c
	src/treebuilder/in_head.c
	src/treebuilder/in_head_noscript.c
	src/treebuilder/after_head.c
	src/treebuilder/in_body.c
	src/treebuilder/in_table.c
	src/treebuilder/in_caption.c
	src/treebuilder/in_column_group.c
	src/treebuilder/in_table_body.c
	src/treebuilder/in_row.c
	src/treebuilder/in_cell.c
	src/treebuilder/in_select.c
	src/treebuilder/in_select_in_table.c
	src/treebuilder/in_foreign_content.c
	src/treebuilder/after_body.c
	src/treebuilder/in_frameset.c
	src/treebuilder/after_frameset.c
	src/treebuilder/after_after_body.c
	src/treebuilder/after_after_frameset.c
	src/treebuilder/generic_rcdata.c
	src/treebuilder/element-type.c
	src/utils/string.c
	src/utils/errors.c
)
set_target_properties(hubbub PROPERTIES SOVERSION ${NEOSURF_ABI})

target_link_libraries(hubbub parserutils)

include_directories(
	${CMAKE_SOURCE_DIR}/contrib/libhubbub/src
	${CMAKE_BINARY_DIR}/contrib/libhubbub/src
)

install(TARGETS hubbub
	RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
	LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
)