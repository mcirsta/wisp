add_custom_command(
    OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/colors.gperf
    COMMAND ${CMAKE_COMMAND} -E make_directory ${CMAKE_CURRENT_BINARY_DIR}/src
    COMMAND ${PYTHON3} ${CMAKE_SOURCE_DIR}/utils/cmake_helper.py convert-eol "${CMAKE_SOURCE_DIR}/contrib/libsvgtiny/src/colors.gperf" "${CMAKE_CURRENT_BINARY_DIR}/colors.gperf"
    DEPENDS ${CMAKE_SOURCE_DIR}/contrib/libsvgtiny/src/colors.gperf
)
add_custom_command(
    OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/src/autogenerated_colors.c
    COMMAND ${GPERF} ${CMAKE_CURRENT_BINARY_DIR}/colors.gperf --output-file=${CMAKE_CURRENT_BINARY_DIR}/src/autogenerated_colors.c
    DEPENDS ${CMAKE_CURRENT_BINARY_DIR}/colors.gperf
)
add_custom_target(svgtiny_autogen DEPENDS ${CMAKE_CURRENT_BINARY_DIR}/src/autogenerated_colors.c)

add_library(svgtiny SHARED
    src/svgtiny.c
    src/svgtiny_gradient.c
    src/svgtiny_list.c
    src/svgtiny_parse.c
    src/svgtiny_path.c
)
set_target_properties(svgtiny PROPERTIES SOVERSION ${NEOSURF_ABI})

add_dependencies(svgtiny svgtiny_autogen)

target_link_libraries(svgtiny nsutils dom m)

target_include_directories(svgtiny PRIVATE
	${CMAKE_SOURCE_DIR}/contrib/libsvgtiny/src
	${CMAKE_BINARY_DIR}/contrib/libsvgtiny/src
	${CMAKE_SOURCE_DIR}/contrib/libdom/bindings
)

install(TARGETS svgtiny
    RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
)

add_executable(svgtiny_test_svg2mvg
    ${CMAKE_SOURCE_DIR}/contrib/libsvgtiny/test/svg2mvg.c
)
target_include_directories(svgtiny_test_svg2mvg PRIVATE
    ${CMAKE_SOURCE_DIR}/contrib/libsvgtiny/include
)
target_link_libraries(svgtiny_test_svg2mvg svgtiny)
add_custom_command(TARGET svgtiny_test_svg2mvg POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy_if_different $<TARGET_FILE:svgtiny> $<TARGET_FILE_DIR:svgtiny_test_svg2mvg>
    COMMAND ${CMAKE_COMMAND} -E copy_if_different $<TARGET_FILE:dom> $<TARGET_FILE_DIR:svgtiny_test_svg2mvg>
    COMMAND ${CMAKE_COMMAND} -E copy_if_different $<TARGET_FILE:parserutils> $<TARGET_FILE_DIR:svgtiny_test_svg2mvg>
    COMMAND ${CMAKE_COMMAND} -E copy_if_different $<TARGET_FILE:hubbub> $<TARGET_FILE_DIR:svgtiny_test_svg2mvg>
    COMMAND ${CMAKE_COMMAND} -E copy_if_different $<TARGET_FILE:nsutils> $<TARGET_FILE_DIR:svgtiny_test_svg2mvg>
)

set(SVGTINY_TEST_DATA_DIR ${CMAKE_SOURCE_DIR}/contrib/libsvgtiny/test/data)
file(GLOB SVGTINY_TEST_MVG_FILES "${SVGTINY_TEST_DATA_DIR}/*.mvg")
set(SVGTINY_TEST_OUT_DIR "${CMAKE_BINARY_DIR}/contrib/libsvgtiny/test/mvg")
set(SVGTINY_TEST_CANON_DIR "${CMAKE_BINARY_DIR}/contrib/libsvgtiny/test/data")
set(SVGTINY_TEST_CANON_OUTPUTS)

foreach(MVG_FILE ${SVGTINY_TEST_MVG_FILES})
    get_filename_component(TEST_NAME ${MVG_FILE} NAME_WE)
    set(SVG_FILE "${SVGTINY_TEST_DATA_DIR}/${TEST_NAME}.svg")
    set(MVG_CANON "${SVGTINY_TEST_CANON_DIR}/${TEST_NAME}.mvg")
    add_custom_command(
        OUTPUT ${MVG_CANON}
        COMMAND ${CMAKE_COMMAND} -E make_directory ${SVGTINY_TEST_CANON_DIR}
        COMMAND ${PYTHON3} ${CMAKE_SOURCE_DIR}/utils/cmake_helper.py convert-eol "${MVG_FILE}" "${MVG_CANON}"
        DEPENDS ${MVG_FILE}
    )
    list(APPEND SVGTINY_TEST_CANON_OUTPUTS ${MVG_CANON})
    if(EXISTS "${SVG_FILE}")
        set(TEST_SCRIPT "${CMAKE_BINARY_DIR}/contrib/libsvgtiny/test/${TEST_NAME}.cmake")
        file(GENERATE OUTPUT "${TEST_SCRIPT}" CONTENT
"file(MAKE_DIRECTORY \"${SVGTINY_TEST_OUT_DIR}\")\nexecute_process(COMMAND \"$<TARGET_FILE:svgtiny_test_svg2mvg>\" \"${SVG_FILE}\" \"1.0\" \"${SVGTINY_TEST_OUT_DIR}/${TEST_NAME}.mvg\" RESULT_VARIABLE R)\nif(NOT R EQUAL 0)\n  message(FATAL_ERROR \"svgtiny_test_svg2mvg failed: ${TEST_NAME}\")\nendif()\nexecute_process(COMMAND \"${CMAKE_COMMAND}\" -E compare_files \"${MVG_CANON}\" \"${SVGTINY_TEST_OUT_DIR}/${TEST_NAME}.mvg\" RESULT_VARIABLE CR)\nif(NOT CR EQUAL 0)\n  message(FATAL_ERROR \"Output mismatch: ${TEST_NAME}\")\nendif()\n")
        add_test(NAME svgtiny_svg2mvg_${TEST_NAME}
                 COMMAND ${CMAKE_COMMAND} -P "${TEST_SCRIPT}")
    endif()
endforeach()

add_custom_target(svgtiny_tests_canonical DEPENDS ${SVGTINY_TEST_CANON_OUTPUTS})
add_dependencies(svgtiny_test_svg2mvg svgtiny_tests_canonical)

# Additional large-path decode test without canonical compare
set(WORDMARK_SVG "${CMAKE_SOURCE_DIR}/contrib/libsvgtiny/test/data/wikipedia-wordmark-en.svg")
set(WORDMARK_SCRIPT "${CMAKE_BINARY_DIR}/contrib/libsvgtiny/test/wikipedia-wordmark-en.cmake")
file(GENERATE OUTPUT "${WORDMARK_SCRIPT}" CONTENT
"file(MAKE_DIRECTORY \"${SVGTINY_TEST_OUT_DIR}\")\nexecute_process(COMMAND \"$<TARGET_FILE:svgtiny_test_svg2mvg>\" \"${WORDMARK_SVG}\" \"1.0\" \"${SVGTINY_TEST_OUT_DIR}/wikipedia-wordmark-en.mvg\" RESULT_VARIABLE R)\nif(NOT R EQUAL 0)\n  message(FATAL_ERROR \"svgtiny_test_svg2mvg failed: wikipedia-wordmark-en\")\nendif()\n")
add_test(NAME svgtiny_svg2mvg_wikipedia_wordmark_en
         COMMAND ${CMAKE_COMMAND} -P "${WORDMARK_SCRIPT}")
